#!/usr/bin/env bash

# shellcheck source=/dev/null
source bin/log

declare ca=""

# Print usage information
print_usage() {
    echo "Usage: $0 --ca ca-slug"
}

# Check if required parameters are set
chk_params() {
    if [[ -z "${ca}" ]]; then
        log_err "parameter --ca is required"
        print_usage
        exit 1
    fi
}

# Get parameters
get_params() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --ca)
                ca=$2
                shift
                ;;
            *)
                log_err "Unknown parameter: $1"
                print_usage
                exit 1
                ;;
        esac
        shift
    done
}

gen_crl() {
    log_info "Generating CRL for ${ca}"

    openssl ca \
        -gencrl \
        -config "etc/${ca}-ca.cnf" \
        -passin "file:ca/private/${ca}-ca.pwd" \
        -out "pub/${ca}-ca.crl.pem"
	openssl crl -in "pub/${ca}-ca.crl.pem" -out "pub/${ca}-ca.crl.der" -outform DER

    log_info "Generated CRL for ${ca}"
}

# Main function
main() {
    get_params "$@"
    chk_params
    gen_crl
}

main "$@"
