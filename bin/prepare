#!/usr/bin/env bash

# shellcheck source=/dev/null
source bin/log

declare ca=""

# Print usage information
print_usage() {
    echo "Usage: $0 --ca ca-slug"
}

# Check if required parameters are set
chk_params() {
    if [[ -z "${ca}" ]]; then
        log_err "parameter --ca is required"
        print_usage
        exit 1
    fi
}

# Get parameters
get_params() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --ca)
                ca=$2
                shift
                ;;
            *)
                log_err "Unknown parameter: $1"
                print_usage
                exit 1
                ;;
        esac
        shift
    done
}

prepare_ca() {
    log_info "Creating directory structure for ${ca}"
    
    mkdir -m 755 -p ca/{certs,reqs} dist pub
	mkdir -m 700 -p ca/{archive,db,new,private}
	
    install -m 600 /dev/null ca/db/${ca}-ca.txt
	install -m 600 /dev/null ca/db/${ca}-ca.txt.attr
	install -m 600 /dev/null ca/db/${ca}-ca.crlnumber
	
    date > ca/db/${ca}-ca.dat
    echo "unique_subject = no" > ca/db/${ca}-ca.txt.attr
    echo 01 > ca/db/${ca}-ca.crlnumber

    log_info "Finished creating directory structure ${ca}"
}

# Main function
main() {
    get_params "$@"
    chk_params
    prepare_ca
}

main "$@"
