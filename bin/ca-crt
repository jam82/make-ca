#!/usr/bin/env bash

# shellcheck source=/dev/null
source bin/log

declare ca=""

# Print usage information
print_usage() {
	echo "Usage: $0 --ca slug"
}

# Check if required parameters are set
chk_params() {
	if [[ -z "${ca}" ]]; then
		log_err "parameter --ca is required"
		print_usage
		exit 1
	fi
}

# Get parameters
get_params() {
	while [[ $# -gt 0 ]]; do
		case $1 in
			--ca)
				ca=$2
				shift
				;;
			*)
				log_err "Unknown parameter: $1"
				print_usage
				exit 1
				;;
		esac
		shift
	done
}

get_config() {
	echo -n "/usr/bin/openssl ca -batch -notext -create_serial "

	if [[ "${ca}" == "root" ]]; then
		echo -n "-config etc/root-ca.cnf "
		echo -n "-passin file:ca/private/root-ca.pwd "
		echo -n "-selfsign "
	elif [[ "${ca}" == "intermediate" ]]; then
		echo -n "-config etc/root-ca.cnf "
		echo -n "-keyfile ca/private/root-ca.key.pem "
		echo -n "-passin file:ca/private/root-ca.pwd "
	else
		echo -n "-config etc/intermediate-ca.cnf "
		echo -n "-keyfile ca/private/intermediate-ca.key.pem "
		echo -n "-passin file:ca/private/intermediate-ca.pwd "
	fi

	echo "-in ca/reqs/${ca}-ca.csr.pem -out ca/certs/${ca}-ca.pem"
}

main() {
	get_params "$@"
	chk_params
	eval "$(get_config)"
}

main "$@"
